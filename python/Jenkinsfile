pipeline {
    agent any
    parameters {
        booleanParam(
            name: 'DOCKER_CACHE',
            defaultValue: true,
            description: 'Define when to use the docker cache.'
        )
    }
    environment {
        IMAGE_NAME = "mmorejon/devops-python:${env.BRANCH_NAME}"
        IMAGE_NAME_BUILD = "${env.IMAGE_NAME}-b${env.BUILD_NUMBER}"
        TAG = "${env.BRANCH_NAME}-b${env.BUILD_NUMBER}"
        INSTANCE_NUMBER = 3
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: 5 ))
        disableConcurrentBuilds()
        timeout(time: 5, unit: 'MINUTES')
    }
    stages {
        stage('build') {
            steps {
                sh "docker image build \
                    ${params.DOCKER_CACHE ? '' : '--no-cache'} \
                    --tag '${IMAGE_NAME}' \
                    ./python"
            }
        }
        stage('test') {
            steps {
                echo "Without tests."
            }
        }
        stage('publish') {
            when { branch 'master' }
            steps {
                withDockerRegistry(credentialsId: 'USER_MMOREJON', url: "https://index.docker.io/v1/") {
                    sh "docker image push '${IMAGE_NAME}'"
                    sh "docker image tag '${IMAGE_NAME}' '${IMAGE_NAME_BUILD}'"
                    sh "docker image push '${IMAGE_NAME_BUILD}'"
                }
            }
        }
        stage('deploy') {
            when { branch 'master' }
            steps {
                // cluster deployment
                withKubeConfig(credentialsId: 'EXAMPLE_CLUSTER' ) {
                    sh """
                        helm upgrade \
                            --install \
                            -f ./cluster/example/values.yaml \
                            --set imageTag=${TAG} \
                            --set replicas=${INSTANCE_NUMBER} \
                            devops-python \
                            ./cluster/example
                    """
                    // check rollout status
                    sh "kubectl rollout status deployment devops-python"
                }
            }
        }
    }
    post {
        always {
            echo "Send slack notification."
        }
    }
}